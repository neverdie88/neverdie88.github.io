"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6989],{60954:function(e,t,a){a.d(t,{EI:function(){return function e(t,a){if(t===a)return!0;if(null==t||null==a)return!1;if("object"!=typeof t&&"object"!=typeof a)return t===a;if(t.constructor!==a.constructor)return!1;if(t instanceof Date&&a instanceof Date)return t.getTime()===a.getTime();if(Array.isArray(t)){if(t.length!==a.length)return!1;for(let s=0;s<t.length;s++)if(!e(t[s],a[s]))return!1;return!0}let s=Object.keys(t),r=Object.keys(a);if(s.length!==r.length)return!1;for(let o of s)if(!r.includes(o)||!e(t[o],a[o]))return!1;return!0}},Pu:function(){return en},gP:function(){return O}});var s,r=a(83366),o=a(83809),i=a(52933),l=a(91215),n=a(76137);let u=["abortSignal"],p=["messageId"];function c(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),a.push.apply(a,s)}return a}function d(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?c(Object(a),!0).forEach(function(t){(0,o.default)(e,t,a[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):c(Object(a)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))})}return e}var h=Object.defineProperty;Symbol.for("vercel.ai.error.AI_NoOutputSpecifiedError"),l.AX,Symbol.for("vercel.ai.error.AI_InvalidArgumentError"),l.AX,Symbol.for("vercel.ai.error.AI_RetryError"),l.AX,Symbol.for("vercel.ai.error.AI_DownloadError"),l.AX,Symbol.for("vercel.ai.error.AI_InvalidDataContentError"),l.AX;var g=n.G0([n.Z_(),n.Pp(Uint8Array),n.Pp(ArrayBuffer),n.PG(e=>{var t,a;return null!=(a=null==(t=globalThis.Buffer)?void 0:t.isBuffer(e))&&a},{message:"Must be a Buffer"})]);Symbol.for("vercel.ai.error.AI_InvalidMessageRoleError"),l.AX;var m=n.Vo(()=>n.G0([n.lB(),n.Z_(),n.Rx(),n.O7(),n.IM(n.Z_(),m),n.IX(m)])),f=n.IM(n.Z_(),n.IM(n.Z_(),m)),_=n.Ry({type:n.i0("text"),text:n.Z_(),providerOptions:f.optional()}),y=n.Ry({type:n.i0("image"),image:n.G0([g,n.Pp(URL)]),mediaType:n.Z_().optional(),providerOptions:f.optional()}),I=n.Ry({type:n.i0("file"),data:n.G0([g,n.Pp(URL)]),filename:n.Z_().optional(),mediaType:n.Z_(),providerOptions:f.optional()}),E=n.Ry({type:n.i0("reasoning"),text:n.Z_(),providerOptions:f.optional()}),v=n.Ry({type:n.i0("tool-call"),toolCallId:n.Z_(),toolName:n.Z_(),input:n._4(),providerOptions:f.optional(),providerExecuted:n.O7().optional()}),b=n.VK("type",[n.Ry({type:n.i0("text"),value:n.Z_()}),n.Ry({type:n.i0("json"),value:m}),n.Ry({type:n.i0("error-text"),value:n.Z_()}),n.Ry({type:n.i0("error-json"),value:m}),n.Ry({type:n.i0("content"),value:n.IX(n.G0([n.Ry({type:n.i0("text"),text:n.Z_()}),n.Ry({type:n.i0("media"),data:n.Z_(),mediaType:n.Z_()})]))})]),R=n.Ry({type:n.i0("tool-result"),toolCallId:n.Z_(),toolName:n.Z_(),output:b,providerOptions:f.optional()}),A=n.Ry({role:n.i0("system"),content:n.Z_(),providerOptions:f.optional()}),T=n.Ry({role:n.i0("user"),content:n.G0([n.Z_(),n.IX(n.G0([_,y,I]))]),providerOptions:f.optional()}),x=n.Ry({role:n.i0("assistant"),content:n.G0([n.Z_(),n.IX(n.G0([_,I,E,v,R]))]),providerOptions:f.optional()}),S=n.Ry({role:n.i0("tool"),content:n.IX(R),providerOptions:f.optional()});n.G0([A,T,x,S]),Symbol.for("vercel.ai.error.AI_InvalidToolInputError"),l.AX,Symbol.for("vercel.ai.error.AI_NoSuchToolError"),l.AX,Symbol.for("vercel.ai.error.AI_ToolCallRepairError"),l.AX,(0,i.bF)({prefix:"aitxt",size:24}),TransformStream;var w=n.G0([n.cf({type:n.i0("text-start"),id:n.Z_()}),n.cf({type:n.i0("text-delta"),id:n.Z_(),delta:n.Z_()}),n.cf({type:n.i0("text-end"),id:n.Z_()}),n.cf({type:n.i0("error"),errorText:n.Z_()}),n.cf({type:n.i0("tool-input-start"),toolCallId:n.Z_(),toolName:n.Z_(),providerExecuted:n.O7().optional()}),n.cf({type:n.i0("tool-input-delta"),toolCallId:n.Z_(),inputTextDelta:n.Z_()}),n.cf({type:n.i0("tool-input-available"),toolCallId:n.Z_(),toolName:n.Z_(),input:n._4(),providerExecuted:n.O7().optional()}),n.cf({type:n.i0("tool-output-available"),toolCallId:n.Z_(),output:n._4(),providerExecuted:n.O7().optional()}),n.cf({type:n.i0("tool-output-error"),toolCallId:n.Z_(),errorText:n.Z_(),providerExecuted:n.O7().optional()}),n.cf({type:n.i0("reasoning"),text:n.Z_(),providerMetadata:n.IM(n.Z_(),n.Yj()).optional()}),n.cf({type:n.i0("reasoning-start"),id:n.Z_(),providerMetadata:n.IM(n.Z_(),n.Yj()).optional()}),n.cf({type:n.i0("reasoning-delta"),id:n.Z_(),delta:n.Z_(),providerMetadata:n.IM(n.Z_(),n.Yj()).optional()}),n.cf({type:n.i0("reasoning-end"),id:n.Z_(),providerMetadata:n.IM(n.Z_(),n.Yj()).optional()}),n.cf({type:n.i0("reasoning-part-finish")}),n.cf({type:n.i0("source-url"),sourceId:n.Z_(),url:n.Z_(),title:n.Z_().optional(),providerMetadata:n.Yj().optional()}),n.cf({type:n.i0("source-document"),sourceId:n.Z_(),mediaType:n.Z_(),title:n.Z_(),filename:n.Z_().optional(),providerMetadata:n.Yj().optional()}),n.cf({type:n.i0("file"),url:n.Z_(),mediaType:n.Z_()}),n.cf({type:n.Z_().startsWith("data-"),id:n.Z_().optional(),data:n._4(),transient:n.O7().optional()}),n.cf({type:n.i0("start-step")}),n.cf({type:n.i0("finish-step")}),n.cf({type:n.i0("start"),messageId:n.Z_().optional(),messageMetadata:n._4().optional()}),n.cf({type:n.i0("finish"),messageMetadata:n._4().optional()}),n.cf({type:n.i0("message-metadata"),messageMetadata:n._4()})]);function C(e,t){if(void 0===e&&void 0===t)return;if(void 0===e)return t;if(void 0===t)return e;let a=d({},e);for(let s in t)if(Object.prototype.hasOwnProperty.call(t,s)){let r=t[s];if(void 0===r)continue;let o=s in e?e[s]:void 0,i=null!==r&&"object"==typeof r&&!Array.isArray(r)&&!(r instanceof Date)&&!(r instanceof RegExp),l=null!=o&&"object"==typeof o&&!Array.isArray(o)&&!(o instanceof Date)&&!(o instanceof RegExp);i&&l?a[s]=C(o,r):a[s]=r}return a}async function O(e){if(void 0===e)return{value:void 0,state:"undefined-input"};let t=await (0,i.NX)({text:e});return t.success?{value:t.value,state:"successful-parse"}:(t=await (0,i.NX)({text:function(e){let t=["ROOT"],a=-1,s=null;function r(e,r,o){switch(e){case'"':a=r,t.pop(),t.push(o),t.push("INSIDE_STRING");break;case"f":case"t":case"n":a=r,s=r,t.pop(),t.push(o),t.push("INSIDE_LITERAL");break;case"-":t.pop(),t.push(o),t.push("INSIDE_NUMBER");break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":a=r,t.pop(),t.push(o),t.push("INSIDE_NUMBER");break;case"{":a=r,t.pop(),t.push(o),t.push("INSIDE_OBJECT_START");break;case"[":a=r,t.pop(),t.push(o),t.push("INSIDE_ARRAY_START")}}function o(e,s){switch(e){case",":t.pop(),t.push("INSIDE_OBJECT_AFTER_COMMA");break;case"}":a=s,t.pop()}}function i(e,s){switch(e){case",":t.pop(),t.push("INSIDE_ARRAY_AFTER_COMMA");break;case"]":a=s,t.pop()}}for(let l=0;l<e.length;l++){let n=e[l];switch(t[t.length-1]){case"ROOT":r(n,l,"FINISH");break;case"INSIDE_OBJECT_START":switch(n){case'"':t.pop(),t.push("INSIDE_OBJECT_KEY");break;case"}":a=l,t.pop()}break;case"INSIDE_OBJECT_AFTER_COMMA":'"'===n&&(t.pop(),t.push("INSIDE_OBJECT_KEY"));break;case"INSIDE_OBJECT_KEY":'"'===n&&(t.pop(),t.push("INSIDE_OBJECT_AFTER_KEY"));break;case"INSIDE_OBJECT_AFTER_KEY":":"===n&&(t.pop(),t.push("INSIDE_OBJECT_BEFORE_VALUE"));break;case"INSIDE_OBJECT_BEFORE_VALUE":r(n,l,"INSIDE_OBJECT_AFTER_VALUE");break;case"INSIDE_OBJECT_AFTER_VALUE":o(n,l);break;case"INSIDE_STRING":switch(n){case'"':t.pop(),a=l;break;case"\\":t.push("INSIDE_STRING_ESCAPE");break;default:a=l}break;case"INSIDE_ARRAY_START":"]"===n?(a=l,t.pop()):(a=l,r(n,l,"INSIDE_ARRAY_AFTER_VALUE"));break;case"INSIDE_ARRAY_AFTER_VALUE":switch(n){case",":t.pop(),t.push("INSIDE_ARRAY_AFTER_COMMA");break;case"]":a=l,t.pop();break;default:a=l}break;case"INSIDE_ARRAY_AFTER_COMMA":r(n,l,"INSIDE_ARRAY_AFTER_VALUE");break;case"INSIDE_STRING_ESCAPE":t.pop(),a=l;break;case"INSIDE_NUMBER":switch(n){case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":a=l;break;case"e":case"E":case"-":case".":break;case",":t.pop(),"INSIDE_ARRAY_AFTER_VALUE"===t[t.length-1]&&i(n,l),"INSIDE_OBJECT_AFTER_VALUE"===t[t.length-1]&&o(n,l);break;case"}":t.pop(),"INSIDE_OBJECT_AFTER_VALUE"===t[t.length-1]&&o(n,l);break;case"]":t.pop(),"INSIDE_ARRAY_AFTER_VALUE"===t[t.length-1]&&i(n,l);break;default:t.pop()}break;case"INSIDE_LITERAL":{let r=e.substring(s,l+1);"false".startsWith(r)||"true".startsWith(r)||"null".startsWith(r)?a=l:(t.pop(),"INSIDE_OBJECT_AFTER_VALUE"===t[t.length-1]?o(n,l):"INSIDE_ARRAY_AFTER_VALUE"===t[t.length-1]&&i(n,l))}}}let l=e.slice(0,a+1);for(let a=t.length-1;a>=0;a--)switch(t[a]){case"INSIDE_STRING":l+='"';break;case"INSIDE_OBJECT_KEY":case"INSIDE_OBJECT_AFTER_KEY":case"INSIDE_OBJECT_AFTER_COMMA":case"INSIDE_OBJECT_START":case"INSIDE_OBJECT_BEFORE_VALUE":case"INSIDE_OBJECT_AFTER_VALUE":l+="}";break;case"INSIDE_ARRAY_START":case"INSIDE_ARRAY_AFTER_COMMA":case"INSIDE_ARRAY_AFTER_VALUE":l+="]";break;case"INSIDE_LITERAL":{let t=e.substring(s,e.length);"true".startsWith(t)?l+="true".slice(t.length):"false".startsWith(t)?l+="false".slice(t.length):"null".startsWith(t)&&(l+="null".slice(t.length))}}return l}(e)})).success?{value:t.value,state:"repaired-parse"}:{value:void 0,state:"failed-parse"}}function N(e){return e.type.startsWith("tool-")}function Z(e){return e.type.split("-")[1]}function M(e){return"object"==typeof e&&null!==e}async function k({stream:e,onError:t}){let a=e.getReader();try{for(;;){let{done:e}=await a.read();if(e)break}}catch(e){null==t||t(e)}finally{a.releaseLock()}}(0,i.bF)({prefix:"aitxt",size:24}),Symbol.for("vercel.ai.error.AI_InvalidStreamPartError"),l.AX,Symbol.for("vercel.ai.error.AI_MCPClientError"),l.AX,Symbol.for("vercel.ai.error.AI_NoImageGeneratedError"),l.AX;var D="AI_NoObjectGeneratedError",j=`vercel.ai.error.${D}`,P=Symbol.for(j),F=class extends l.AX{constructor({message:e="No object generated.",cause:t,text:a,response:r,usage:o,finishReason:i}){super({name:D,message:e,cause:t}),this[s]=!0,this.text=a,this.response=r,this.usage=o,this.finishReason=i}static isInstance(e){return l.AX.hasMarker(e,j)}};s=P,Symbol.for("vercel.ai.error.AI_MessageConversionError"),l.AX,(0,i.bF)({prefix:"aiobj",size:24});var B=class{constructor(){this.queue=[],this.isProcessing=!1}async processQueue(){if(!this.isProcessing){for(this.isProcessing=!0;this.queue.length>0;)await this.queue[0](),this.queue.shift();this.isProcessing=!1}}async run(e){return new Promise((t,a)=>{this.queue.push(async()=>{try{await e(),t()}catch(e){a(e)}}),this.processQueue()})}};(0,i.bF)({prefix:"aiobj",size:24}),l.AX,((e,t)=>{for(var a in t)h(e,a,{get:t[a],enumerable:!0})})({},{object:()=>J,text:()=>L});var L=()=>({type:"text",responseFormat:{type:"text"},parsePartial:async({text:e})=>({partial:e}),parseOutput:async({text:e})=>e}),J=({schema:e})=>{let t=(0,i.C3)(e);return{type:"object",responseFormat:{type:"json",schema:t.jsonSchema},async parsePartial({text:e}){let t=await O(e);switch(t.state){case"failed-parse":case"undefined-input":return;case"repaired-parse":case"successful-parse":return{partial:t.value};default:{let e=t.state;throw Error(`Unsupported parse state: ${e}`)}}},async parseOutput({text:e},a){let s=await (0,i.NX)({text:e});if(!s.success)throw new F({message:"No object generated: could not parse the response.",cause:s.error,text:e,response:a.response,usage:a.usage,finishReason:a.finishReason});let r=await (0,i.pW)({value:s.value,schema:t});if(!r.success)throw new F({message:"No object generated: response did not match schema.",cause:r.error,text:e,response:a.response,usage:a.usage,finishReason:a.finishReason});return r.value}}};Symbol.for("vercel.ai.error.AI_NoSuchProviderError"),l.JJ;var X=n.Ry({name:n.Z_(),version:n.Z_()}).passthrough(),Y=n.Ry({_meta:n.jt(n.Ry({}).passthrough())}).passthrough(),G=n.Ry({method:n.Z_(),params:n.jt(Y)}),U=n.Ry({experimental:n.jt(n.Ry({}).passthrough()),logging:n.jt(n.Ry({}).passthrough()),prompts:n.jt(n.Ry({listChanged:n.jt(n.O7())}).passthrough()),resources:n.jt(n.Ry({subscribe:n.jt(n.O7()),listChanged:n.jt(n.O7())}).passthrough()),tools:n.jt(n.Ry({listChanged:n.jt(n.O7())}).passthrough())}).passthrough();Y.extend({protocolVersion:n.Z_(),capabilities:U,serverInfo:X,instructions:n.jt(n.Z_())});var q=Y.extend({nextCursor:n.jt(n.Z_())}),V=n.Ry({name:n.Z_(),description:n.jt(n.Z_()),inputSchema:n.Ry({type:n.i0("object"),properties:n.jt(n.Ry({}).passthrough())}).passthrough()}).passthrough();q.extend({tools:n.IX(V)});var W=n.Ry({type:n.i0("text"),text:n.Z_()}).passthrough(),K=n.Ry({type:n.i0("image"),data:n.Z_().base64(),mimeType:n.Z_()}).passthrough(),$=n.Ry({uri:n.Z_(),mimeType:n.jt(n.Z_())}).passthrough(),z=$.extend({text:n.Z_()}),Q=$.extend({blob:n.Z_().base64()}),H=n.Ry({type:n.i0("resource"),resource:n.G0([z,Q])}).passthrough();Y.extend({content:n.IX(n.G0([W,K,H])),isError:n.O7().default(!1).optional()}).or(Y.extend({toolResult:n._4()}));var ee=n.Ry({jsonrpc:n.i0("2.0"),id:n.G0([n.Z_(),n.Rx().int()])}).merge(G).strict(),et=n.Ry({jsonrpc:n.i0("2.0"),id:n.G0([n.Z_(),n.Rx().int()]),result:Y}).strict(),ea=n.Ry({jsonrpc:n.i0("2.0"),id:n.G0([n.Z_(),n.Rx().int()]),error:n.Ry({code:n.Rx().int(),message:n.Z_(),data:n.jt(n._4())})}).strict(),es=n.Ry({jsonrpc:n.i0("2.0")}).merge(n.Ry({method:n.Z_(),params:n.jt(Y)})).strict();async function er(e){if(null==e)return[];if(!globalThis.FileList||!(e instanceof globalThis.FileList))throw Error("FileList is not supported in the current environment");return Promise.all(Array.from(e).map(async e=>{let{name:t,type:a}=e;return{type:"file",mediaType:a,filename:t,url:await new Promise((t,a)=>{let s=new FileReader;s.onload=e=>{var a;t(null==(a=e.target)?void 0:a.result)},s.onerror=e=>a(e),s.readAsDataURL(e)})}}))}n.G0([ee,es,et,ea]),l.AX;var eo=class{constructor({api:e="/api/chat",credentials:t,headers:a,body:s,fetch:r,prepareSendMessagesRequest:o,prepareReconnectToStreamRequest:i}){this.api=e,this.credentials=t,this.headers=a,this.body=s,this.fetch=r,this.prepareSendMessagesRequest=o,this.prepareReconnectToStreamRequest=i}async sendMessages(e){var t,a,s,o,l;let{abortSignal:n}=e,p=(0,r.Z)(e,u),c=await (0,i.DB)(this.body),h=await (0,i.DB)(this.headers),g=await (0,i.DB)(this.credentials),m=await (null==(t=this.prepareSendMessagesRequest)?void 0:t.call(this,{api:this.api,id:p.chatId,messages:p.messages,body:d(d({},c),p.body),headers:d(d({},h),p.headers),credentials:g,requestMetadata:p.metadata,trigger:p.trigger,messageId:p.messageId})),f=null!=(a=null==m?void 0:m.api)?a:this.api,_=(null==m?void 0:m.headers)!==void 0?m.headers:d(d({},h),p.headers),y=(null==m?void 0:m.body)!==void 0?m.body:d(d(d({},c),p.body),{},{id:p.chatId,messages:p.messages,trigger:p.trigger,messageId:p.messageId}),I=null!=(s=null==m?void 0:m.credentials)?s:g,E=null!=(o=this.fetch)?o:globalThis.fetch,v=await E(f,{method:"POST",headers:d({"Content-Type":"application/json"},_),body:JSON.stringify(y),credentials:I,signal:n});if(!v.ok)throw Error(null!=(l=await v.text())?l:"Failed to fetch the chat response.");if(!v.body)throw Error("The response body is empty.");return this.processResponseStream(v.body)}async reconnectToStream(e){var t,a,s,r,o;let l=await (0,i.DB)(this.body),n=await (0,i.DB)(this.headers),u=await (0,i.DB)(this.credentials),p=await (null==(t=this.prepareReconnectToStreamRequest)?void 0:t.call(this,{api:this.api,id:e.chatId,body:d(d({},l),e.body),headers:d(d({},n),e.headers),credentials:u,requestMetadata:e.metadata})),c=null!=(a=null==p?void 0:p.api)?a:`${this.api}/${e.chatId}/stream`,h=(null==p?void 0:p.headers)!==void 0?p.headers:d(d({},n),e.headers),g=null!=(s=null==p?void 0:p.credentials)?s:u,m=null!=(r=this.fetch)?r:globalThis.fetch,f=await m(c,{method:"GET",headers:h,credentials:g});if(204===f.status)return null;if(!f.ok)throw Error(null!=(o=await f.text())?o:"Failed to fetch the chat response.");if(!f.body)throw Error("The response body is empty.");return this.processResponseStream(f.body)}},ei=class extends eo{constructor(e={}){super(e)}processResponseStream(e){return(0,i.RF)({stream:e,schema:w}).pipeThrough(new TransformStream({async transform(e,t){if(!e.success)throw e.error;t.enqueue(e.value)}}))}};function el(e){if(!e||"assistant"!==e.role)return!1;let t=e.parts.reduce((e,t,a)=>"step-start"===t.type?a:e,-1),a=e.parts.slice(t+1).filter(N);return a.length>0&&a.every(e=>"output-available"===e.state)}var en=class{constructor({generateId:e=i.Ox,id:t=e(),transport:a=new ei,maxSteps:s=1,messageMetadataSchema:o,dataPartSchemas:l,state:n,onError:u,onToolCall:c,onFinish:h,onData:g}){this.activeResponse=void 0,this.jobExecutor=new B,this.sendMessage=async(e,t={})=>{var a,s,r;let o;if(o="text"in e||"files"in e?{parts:[...Array.isArray(e.files)?e.files:await er(e.files),..."text"in e&&null!=e.text?[{type:"text",text:e.text}]:[]]}:e,null!=e.messageId){let t=this.state.messages.findIndex(t=>t.id===e.messageId);if(-1===t)throw Error(`message with id ${e.messageId} not found`);if("user"!==this.state.messages[t].role)throw Error(`message with id ${e.messageId} is not a user message`);this.state.messages=this.state.messages.slice(0,t+1),this.state.replaceMessage(t,d(d({},o),{},{id:e.messageId,role:null!=(a=o.role)?a:"user",metadata:e.metadata}))}else this.state.pushMessage(d(d({},o),{},{id:null!=(s=o.id)?s:this.generateId(),role:null!=(r=o.role)?r:"user",metadata:e.metadata}));await this.makeRequest(d({trigger:"submit-user-message",messageId:e.messageId},t))},this.regenerate=async(e={})=>{let{messageId:t}=e,a=(0,r.Z)(e,p),s=null==t?this.state.messages.length-1:this.state.messages.findIndex(e=>e.id===t);if(-1===s)throw Error(`message ${t} not found`);this.state.messages=this.state.messages.slice(0,"assistant"===this.messages[s].role?s:s+1),await this.makeRequest(d({trigger:"regenerate-assistant-message",messageId:t},a))},this.resumeStream=async(e={})=>{await this.makeRequest(d({trigger:"resume-stream"},e))},this.addToolResult=async({toolCallId:e,output:t})=>{this.jobExecutor.run(async()=>{(function({messages:e,toolCallId:t,output:a}){let s=e[e.length-1].parts.find(e=>N(e)&&e.toolCallId===t);null!=s&&(s.state="output-available",s.output=a)})({messages:this.state.messages,toolCallId:e,output:t}),this.messages=this.state.messages,"submitted"!==this.status&&"streaming"!==this.status&&el(this.lastMessage)&&this.makeRequest({trigger:"submit-tool-result"})})},this.stop=async()=>{var e;("streaming"===this.status||"submitted"===this.status)&&(null==(e=this.activeResponse)?void 0:e.abortController)&&this.activeResponse.abortController.abort()},this.id=t,this.maxSteps=s,this.transport=a,this.generateId=e,this.messageMetadataSchema=o,this.dataPartSchemas=l,this.state=n,this.onError=u,this.onToolCall=c,this.onFinish=h,this.onData=g}get status(){return this.state.status}setStatus({status:e,error:t}){this.status!==e&&(this.state.status=e,this.state.error=t)}get error(){return this.state.error}get messages(){return this.state.messages}get lastMessage(){return this.state.messages[this.state.messages.length-1]}set messages(e){this.state.messages=e}async makeRequest({trigger:e,metadata:t,headers:a,body:s,messageId:r}){var o,l;this.setStatus({status:"submitted",error:void 0});let n=this.state.messages.length,u=this.lastMessage,p=null!=(o=null==u?void 0:u.parts.filter(e=>"step-start"===e.type).length)?o:0;try{let o;let n={state:function({lastMessage:e,messageId:t}){return{message:(null==e?void 0:e.role)==="assistant"?e:{id:t,metadata:void 0,role:"assistant",parts:[]},activeTextParts:{},activeReasoningParts:{},partialToolCalls:{}}}({lastMessage:this.state.snapshot(u),messageId:this.generateId()}),abortController:new AbortController};if(this.activeResponse=n,"resume-stream"===e){let e=await this.transport.reconnectToStream({chatId:this.id,metadata:t,headers:a,body:s});if(null==e)return;o=e}else o=await this.transport.sendMessages({chatId:this.id,messages:this.state.messages,abortSignal:n.abortController.signal,metadata:t,headers:a,body:s,trigger:e,messageId:r});await k({stream:function({stream:e,onToolCall:t,messageMetadataSchema:a,dataPartSchemas:s,runUpdateMessageJob:r,onError:o,onData:l}){return e.pipeThrough(new TransformStream({async transform(e,s){await r(async({state:r,write:n})=>{var u,p;function c(e){var t;let a=r.message.parts.find(t=>N(t)&&t.toolCallId===e.toolCallId);null!=a?(a.state=e.state,a.input=e.input,a.output=e.output,a.errorText=e.errorText,a.providerExecuted=null!=(t=e.providerExecuted)?t:a.providerExecuted):r.message.parts.push({type:`tool-${e.toolName}`,toolCallId:e.toolCallId,state:e.state,input:e.input,output:e.output,errorText:e.errorText,providerExecuted:e.providerExecuted})}async function d(e){if(null!=e){let t=null!=r.message.metadata?C(r.message.metadata,e):e;null!=a&&await (0,i.rJ)({value:t,schema:a}),r.message.metadata=t}}switch(e.type){case"text-start":{let t={type:"text",text:"",state:"streaming"};r.activeTextParts[e.id]=t,r.message.parts.push(t),n();break}case"text-delta":r.activeTextParts[e.id].text+=e.delta,n();break;case"text-end":r.activeTextParts[e.id].state="done",delete r.activeTextParts[e.id],n();break;case"reasoning-start":{let t={type:"reasoning",text:"",providerMetadata:e.providerMetadata,state:"streaming"};r.activeReasoningParts[e.id]=t,r.message.parts.push(t),n();break}case"reasoning-delta":{let t=r.activeReasoningParts[e.id];t.text+=e.delta,t.providerMetadata=null!=(u=e.providerMetadata)?u:t.providerMetadata,n();break}case"reasoning-end":{let t=r.activeReasoningParts[e.id];t.providerMetadata=null!=(p=e.providerMetadata)?p:t.providerMetadata,t.state="done",delete r.activeReasoningParts[e.id],n();break}case"file":r.message.parts.push({type:"file",mediaType:e.mediaType,url:e.url}),n();break;case"source-url":r.message.parts.push({type:"source-url",sourceId:e.sourceId,url:e.url,title:e.title,providerMetadata:e.providerMetadata}),n();break;case"source-document":r.message.parts.push({type:"source-document",sourceId:e.sourceId,mediaType:e.mediaType,title:e.title,filename:e.filename,providerMetadata:e.providerMetadata}),n();break;case"tool-input-start":{let t=r.message.parts.filter(N);r.partialToolCalls[e.toolCallId]={text:"",toolName:e.toolName,index:t.length},c({toolCallId:e.toolCallId,toolName:e.toolName,state:"input-streaming",input:void 0,providerExecuted:e.providerExecuted}),n();break}case"tool-input-delta":{let t=r.partialToolCalls[e.toolCallId];t.text+=e.inputTextDelta;let{value:a}=await O(t.text);c({toolCallId:e.toolCallId,toolName:t.toolName,state:"input-streaming",input:a}),n();break}case"tool-input-available":if(c({toolCallId:e.toolCallId,toolName:e.toolName,state:"input-available",input:e.input,providerExecuted:e.providerExecuted}),n(),t&&!e.providerExecuted){let a=await t({toolCall:e});null!=a&&(c({toolCallId:e.toolCallId,toolName:e.toolName,state:"output-available",input:e.input,output:a}),n())}break;case"tool-output-available":{let t=r.message.parts.filter(N);if(null==t)throw Error("tool_result must be preceded by a tool_call");let a=t.findIndex(t=>t.toolCallId===e.toolCallId);if(-1===a)throw Error("tool_result must be preceded by a tool_call with the same toolCallId");let s=Z(t[a]);c({toolCallId:e.toolCallId,toolName:s,state:"output-available",input:t[a].input,output:e.output,providerExecuted:e.providerExecuted}),n();break}case"tool-output-error":{let t=r.message.parts.filter(N);if(null==t)throw Error("tool_result must be preceded by a tool_call");let a=t.findIndex(t=>t.toolCallId===e.toolCallId);if(-1===a)throw Error("tool_result must be preceded by a tool_call with the same toolCallId");let s=Z(t[a]);c({toolCallId:e.toolCallId,toolName:s,state:"output-error",input:t[a].input,errorText:e.errorText,providerExecuted:e.providerExecuted}),n();break}case"start-step":r.message.parts.push({type:"step-start"});break;case"finish-step":r.activeTextParts={},r.activeReasoningParts={};break;case"start":null!=e.messageId&&(r.message.id=e.messageId),await d(e.messageMetadata),(null!=e.messageId||null!=e.messageMetadata)&&n();break;case"finish":case"message-metadata":await d(e.messageMetadata),null!=e.messageMetadata&&n();break;case"error":null==o||o(Error(e.errorText));break;default:if(e.type.startsWith("data-")){if(e.transient){null==l||l(e);break}let t=null!=e.id?r.message.parts.find(t=>e.type===t.type&&e.id===t.id):void 0;null!=t?t.data=M(t.data)&&M(e.data)?C(t.data,e.data):e.data:r.message.parts.push(e),null==l||l(e),n()}}s.enqueue(e)})}}))}({stream:o,onToolCall:this.onToolCall,onData:this.onData,messageMetadataSchema:this.messageMetadataSchema,dataPartSchemas:this.dataPartSchemas,runUpdateMessageJob:e=>this.jobExecutor.run(()=>e({state:n.state,write:()=>{var e;this.setStatus({status:"streaming"}),n.state.message.id===(null==(e=this.lastMessage)?void 0:e.id)?this.state.replaceMessage(this.state.messages.length-1,n.state.message):this.state.pushMessage(n.state.message)}})),onError:e=>{throw e}}),onError:e=>{throw e}}),null==(l=this.onFinish)||l.call(this,{message:n.state.message}),this.setStatus({status:"ready"})}catch(e){if("AbortError"===e.name)return this.setStatus({status:"ready"}),null;this.onError&&e instanceof Error&&this.onError(e),this.setStatus({status:"error",error:e})}finally{this.activeResponse=void 0}(function({originalMaxToolInvocationStep:e,originalMessageCount:t,maxSteps:a,messages:s}){let r=s[s.length-1],o=r.parts.filter(e=>"step-start"===e.type).length;return a>1&&null!=r&&(s.length>t||o!==e)&&el(r)&&o<a})({originalMaxToolInvocationStep:p,originalMessageCount:n,maxSteps:this.maxSteps,messages:this.state.messages})&&await this.makeRequest({metadata:t,headers:a,body:s,trigger:"submit-tool-result"})}}}}]);