name: LaTeX to HTML (LaTeXML)

on:
  workflow_dispatch:
    inputs:
      archive_url:
        description: "URL to a .tex or .zip/.tar(.gz) LaTeX project"
        required: false
        default: ""
      main_tex:
        description: "Main TeX file path (defaults to main.tex or auto-detected)"
        required: false
        default: "main.tex"
      output_slug:
        description: "Name for the downloadable artifact (e.g., my-paper)"
        required: true
        default: "paper"
  issues:
    types: [opened, edited, labeled]

permissions:
  contents: read
  issues: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare workspace
        run: |
          set -e
          mkdir -p paper out

      - name: Determine trigger
        id: detect_trigger
        run: |
          echo "event_name=${{ github.event_name }}" >> $GITHUB_OUTPUT

      - name: Gather inputs (workflow_dispatch)
        id: gather_wd
        if: ${{ steps.detect_trigger.outputs.event_name == 'workflow_dispatch' }}
        run: |
          echo "archive_url=${{ github.event.inputs.archive_url }}" >> $GITHUB_OUTPUT
          echo "main_tex=${{ github.event.inputs.main_tex }}" >> $GITHUB_OUTPUT
          echo "output_slug=${{ github.event.inputs.output_slug }}" >> $GITHUB_OUTPUT

      - name: Gather inputs (issues)
        id: gather_issue
        if: ${{ steps.detect_trigger.outputs.event_name == 'issues' }}
        env:
          EVENT_PATH: ${{ github.event_path }}
        run: |
          set -e
          body=$(jq -r '.issue.body // ""' "$EVENT_PATH")
          labels=$(jq -r '.issue.labels[].name // empty' "$EVENT_PATH" | tr '\n' ' ')
          title=$(jq -r '.issue.title // ""' "$EVENT_PATH")

          # Gate: require label 'latex-upload' OR 'latex' in title
          if ! echo "$labels $title" | grep -qiE 'latex-upload|latex'; then
            echo "skip_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Parse fields from body
          # output_slug: prefer explicit, else derive from title, else fallback
          output_slug=$(echo "$body" | awk -F':' '/^[[:space:]]*output_slug[[:space:]]*:/ {gsub(/^[[:space:]]+|[[:space:]]+$/,"",$2); print $2; exit}')
          if [ -z "$output_slug" ]; then
            output_slug=$(echo "$title" | tr ' ' '-' | tr -cd '[:alnum:]-' | tr '[:upper:]' '[:lower:]')
            [ -z "$output_slug" ] && output_slug="paper-${GITHUB_RUN_ID}"
          fi

          main_tex=$(echo "$body" | awk -F':' '/^[[:space:]]*main_tex[[:space:]]*:/ {gsub(/^[[:space:]]+|[[:space:]]+$/,"",$2); print $2; exit}')
          [ -z "$main_tex" ] && main_tex="main.tex"

          # First URL found in the body (any). We'll detect the type after download.
          source_url=$(echo "$body" | grep -Eo '(https?://[^) "\r\n]+)' | head -n1 || true)

          echo "output_slug=$output_slug" >> $GITHUB_OUTPUT
          echo "main_tex=$main_tex" >> $GITHUB_OUTPUT
          echo "source_url=$source_url" >> $GITHUB_OUTPUT
          echo "skip_build=false" >> $GITHUB_OUTPUT

      - name: Stop if issue not applicable
        if: ${{ steps.detect_trigger.outputs.event_name == 'issues' && steps.gather_issue.outputs.skip_build == 'true' }}
        run: echo "Skipping: Issue missing label/title signal."

      - name: Fetch source (workflow_dispatch)
        if: ${{ steps.detect_trigger.outputs.event_name == 'workflow_dispatch' && steps.gather_wd.outputs.archive_url != '' }}
        run: |
          set -e
          url="${{ steps.gather_wd.outputs.archive_url }}"
          echo "Downloading: $url"
          curl -sSL -D headers.txt "$url" -o paper.bin
          sudo apt-get update >/dev/null 2>&1 || true
          sudo apt-get install -y unzip >/dev/null 2>&1 || true
          mime=$(file -b --mime-type paper.bin || true)
          name=$(grep -i '^content-disposition:' headers.txt | sed -E 's/.*filename="?([^";]+).*/\1/i' | tr -d '\r' || true)
          [ -z "$name" ] && name="$(basename "${url%%\?*}")"
          echo "Detected mime=$mime name=$name"
          if [ -z "$mime" ]; then mime=$(file -b paper.bin || true); fi

          case "$mime" in
            text/plain|application/x-tex)
              cp paper.bin "paper/${{ steps.gather_wd.outputs.main_tex }}"
              ;;
            application/zip|application/x-zip|application/x-zip-compressed)
              unzip -q paper.bin -d paper
              ;;
            application/gzip|application/x-gzip)
              tar -xzf paper.bin -C paper || true
              ;;
            application/x-tar|application/x-gtar|application/x-archive|application/octet-stream)
              tar -xzf paper.bin -C paper || tar -xf paper.bin -C paper || {
                if echo "$name" | grep -qiE '\.tex$'; then cp paper.bin "paper/${{ steps.gather_wd.outputs.main_tex }}"; else echo "Unknown archive type"; fi
              }
              ;;
            *)
              if echo "$name" | grep -qiE '\.tex$'; then
                cp paper.bin "paper/${{ steps.gather_wd.outputs.main_tex }}"
              elif echo "$name" | grep -qiE '\.(zip|tgz|tar\.gz|tar)$'; then
                tar -xzf paper.bin -C paper || tar -xf paper.bin -C paper || unzip -q paper.bin -d paper || true
              else
                unzip -q paper.bin -d paper || tar -xzf paper.bin -C paper || tar -xf paper.bin -C paper || {
                  echo "Unable to detect file type. Provide a .tex or archive URL." >&2; exit 1;
                }
              fi
              ;;
          esac

      - name: Fetch source (issues)
        if: ${{ steps.detect_trigger.outputs.event_name == 'issues' && steps.gather_issue.outputs.source_url != '' }}
        run: |
          set -e
          url="${{ steps.gather_issue.outputs.source_url }}"
          echo "Downloading: $url"
          curl -sSL -D headers.txt "$url" -o paper.bin
          sudo apt-get update >/dev/null 2>&1 || true
          sudo apt-get install -y unzip >/dev/null 2>&1 || true
          mime=$(file -b --mime-type paper.bin || true)
          name=$(grep -i '^content-disposition:' headers.txt | sed -E 's/.*filename="?([^";]+).*/\1/i' | tr -d '\r' || true)
          [ -z "$name" ] && name="$(basename "${url%%\?*}")"
          echo "Detected mime=$mime name=$name"
          if [ -z "$mime" ]; then mime=$(file -b paper.bin || true); fi

          case "$mime" in
            text/plain|application/x-tex)
              cp paper.bin "paper/${{ steps.gather_issue.outputs.main_tex }}"
              ;;
            application/zip|application/x-zip|application/x-zip-compressed)
              unzip -q paper.bin -d paper
              ;;
            application/gzip|application/x-gzip)
              tar -xzf paper.bin -C paper || true
              ;;
            application/x-tar|application/x-gtar|application/x-archive|application/octet-stream)
              tar -xzf paper.bin -C paper || tar -xf paper.bin -C paper || {
                if echo "$name" | grep -qiE '\.tex$'; then cp paper.bin "paper/${{ steps.gather_issue.outputs.main_tex }}"; else echo "Unknown archive type"; fi
              }
              ;;
            *)
              if echo "$name" | grep -qiE '\.tex$'; then
                cp paper.bin "paper/${{ steps.gather_issue.outputs.main_tex }}"
              elif echo "$name" | grep -qiE '\.(zip|tgz|tar\.gz|tar)$'; then
                tar -xzf paper.bin -C paper || tar -xf paper.bin -C paper || unzip -q paper.bin -d paper || true
              else
                unzip -q paper.bin -d paper || tar -xzf paper.bin -C paper || tar -xf paper.bin -C paper || {
                  echo "Unable to detect file type. Provide a .tex or archive URL." >&2; exit 1;
                }
              fi
              ;;
          esac

      - name: Fallback to repo latex/ (optional)
        if: ${{ (steps.detect_trigger.outputs.event_name == 'workflow_dispatch' && steps.gather_wd.outputs.archive_url == '') || (steps.detect_trigger.outputs.event_name == 'issues' && steps.gather_issue.outputs.source_url == '') }}
        run: |
          set -e
          if [ -d "latex" ]; then
            echo "Using latex/ folder from repo."
            rsync -a latex/ paper/
          else
            echo "No source provided and no latex/ folder. Nothing to convert."
            exit 1
          fi

      - name: Detect main tex
        id: detect_main
        run: |
          set -e
          if [ "${{ steps.detect_trigger.outputs.event_name }}" = "workflow_dispatch" ]; then
            MAIN="${{ steps.gather_wd.outputs.main_tex }}"
          else
            MAIN="${{ steps.gather_issue.outputs.main_tex }}"
          fi

          if [ ! -f "paper/$MAIN" ]; then
            # Try to auto-detect a single .tex
            MATCH=$(find paper -maxdepth 3 -type f -name "*.tex" | head -n1)
            if [ -z "$MATCH" ]; then
              echo "No .tex file found." >&2
              exit 1
            fi
            MAIN="${MATCH#paper/}"
          fi

          echo "main=$MAIN" >> $GITHUB_OUTPUT
          echo "Main TeX: $MAIN"

      - name: Pull LaTeXML docker image
        run: docker pull latexml/latexml:latest

      - name: Convert with LaTeXML
        run: |
          set -e
          echo "Converting ${{ steps.detect_main.outputs.main }} ..."
          docker run --rm \
            -v "$GITHUB_WORKSPACE/paper:/data" \
            -v "$GITHUB_WORKSPACE/out:/out" \
            latexml/latexml:latest \
            latexmlc --format=html5 --destination=/out/index.html \
                     --noparse-errors --path=/data "${{ steps.detect_main.outputs.main }}"
          ls -lah out/ || true

      - name: Decide artifact name (slug)
        id: decide_slug
        run: |
          if [ "${{ steps.detect_trigger.outputs.event_name }}" = "workflow_dispatch" ]; then
            SLUG="${{ steps.gather_wd.outputs.output_slug }}"
          else
            SLUG="${{ steps.gather_issue.outputs.output_slug }}"
          fi
          [ -z "$SLUG" ] && SLUG="paper-${GITHUB_RUN_ID}"
          echo "slug=$SLUG" >> $GITHUB_OUTPUT
          echo "Artifact name: $SLUG"

      - name: Upload HTML bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: latexml-${{ steps.decide_slug.outputs.slug }}
          path: out/
          if-no-files-found: error
          compression-level: 6
          retention-days: 30

      - name: Summarize build info
        run: |
          set -e
          run_url="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          slug="${{ steps.decide_slug.outputs.slug }}"
          main="${{ steps.detect_main.outputs.main }}"
          {
            echo "### LaTeXML conversion complete"
            echo
            echo "- Artifact: latexml-$slug"
            echo "- Contains: index.html (and assets)"
            echo "- Main TeX: $main"
            echo "- Download from: $run_url (Artifacts section)"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Comment on issue with download link
        if: ${{ steps.detect_trigger.outputs.event_name == 'issues' }}
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          issue_number="${{ github.event.issue.number }}"
          run_url="https://github.com/${REPO}/actions/runs/${{ github.run_id }}"
          slug="${{ steps.decide_slug.outputs.slug }}"
          gh api repos/$REPO/issues/$issue_number/comments -f body="LaTeXML conversion completed.\nDownload the HTML bundle artifact (latexml-${slug}) from:\n${run_url}"
